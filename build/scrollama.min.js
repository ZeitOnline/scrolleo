((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).scrollama=t()})(this,function(){let r=null;function O({step:e,marginTop:t}){var o,n,e=e.height;(r=r||((o=document.createElement("div")).className="scrollama__debug-step",o.style.position="fixed",o.style.left="0",o.style.width="100%",o.style.zIndex="9999",o.style.borderTop="2px solid black",o.style.borderBottom="2px solid black",(n=document.createElement("p")).style.position="absolute",n.style.left="0",n.style.height="1px",n.style.width="100%",n.style.borderTop="1px dashed black",o.appendChild(n),document.body.appendChild(o),o)).style.top=-1*t+"px",r.style.height=e+"px",r.querySelector("p").style.top=e/2+"px"}function T(){r&&(r.remove(),r=null)}function z(e){console.error("scrollama error: "+e)}let o=new WeakMap;function F(e){return o.get(e)}function I(e){var t;return"string"==typeof e&&0<e.indexOf("px")?(t=+e.replace("px",""),isNaN(t)?(err("offset value must be in 'px' format. Fallback to 0.5."),{format:"percent",value:.5}):{format:"pixels",value:t}):"number"!=typeof e&&isNaN(+e)?null:(1<e&&err("offset value is greater than 1. Fallback to 1."),e<0&&err("offset value is lower than 0. Fallback to 0."),{format:"percent",value:Math.min(Math.max(0,e),1)})}function P(e){e.forEach(e=>{var t;t=e.node,e=e.index,o.set(t,e)})}let j=new WeakMap;function n(e){return e===window?window.scrollY:e.scrollTop}function H(e){e=e||window,e=j.get(e);return e?e.direction:"down"}function B(e){let o=e||window;j.has(o)?j.get(o).count+=1:(e=()=>{var e,t;e=o,(t=j.get(e))&&(e=n(e),t.previousScrollY!==e)&&(t.previousScrollY<e?t.direction="down":e<t.previousScrollY&&(t.direction="up"),t.previousScrollY=e)},j.set(o,{listener:e,previousScrollY:n(o),direction:"down",count:1}),o.addEventListener("scroll",e,{passive:!0}))}return function(){let i={},a=(()=>{var t="abcdefghijklmnopqrstuvwxyz",e=Date.now(),o=[];for(let e=0;e<6;e+=1){var n=t[Math.floor(Math.random()*t.length)];o.push(n)}return""+o.join("")+e})(),p=[],f,d,u,t,h=0,o=!1,g=!1,m=!1,v=!1,s=[],l=new Map,c=!1,n=new Set,r=!1;function x(){i={stepEnter:()=>{},stepExit:()=>{},stepProgress:()=>{}},s=[],l.clear(),c=!1,n.clear(),r=!1}function y(e){e&&!o&&A(),!e&&o&&q(),o=e}function w(){c=!1,l.forEach(({element:e,index:t,progress:o,direction:n,step:r})=>{r.progress=o,"enter"===r.state&&(r={element:e,index:t,progress:o,direction:n},i.stepProgress(r))}),l.clear()}function b(e,t){var o,n,r;void 0===t||(t=t,o=F(e=e),n=p[o],r=H(d),l.set(o,{element:e,index:o,progress:t,direction:r,step:n}),c)||(c=!0,requestAnimationFrame(w))}function E(){r=!1,n.forEach(e=>{k(e),Y(e,g)}),n.clear()}function e(e){e.forEach(e=>{var t=F(e.target),t=p[t],e=e.target.offsetHeight;e!==t.height&&(t.height=e,n.add(t))}),0<n.size&&!r&&(r=!0,requestAnimationFrame(E))}function S([e]){var t,o,n,{isIntersecting:e,target:r}=e;e?(t=F(e=r),o=p[t],n=H(d),e={element:e,index:t,direction:n},o.direction=n,o.state="enter",s[t]||i.stepEnter(e),v&&(s[t]=!0)):(o=F(n=r),(e=p[o]).state&&(t={element:n,index:o,direction:o=H(d)},g&&("down"===o&&e.progress<1?b(n,1):"up"===o&&0<e.progress&&b(n,0)),e.direction=o,e.state="exit",i.stepExit(t)))}function M([e]){var t=F(e.target),t=p[t],{isIntersecting:e,intersectionRatio:o,target:n}=e;e&&"enter"===t.state&&b(n,o)}function k({observers:t}){Object.keys(t).map(e=>{t[e].disconnect()})}function q(){p.forEach(k),t&&t.disconnect()}function Y(e,t){var o,n,r,i,s;i=e,o=window.innerHeight,n=i.offset||f,s="pixels"===n.format?1:o,n=n.value*s,n=(s=i.height/2-n)+`px 0px ${o=i.height/2-(o-n)}px 0px`,r=u,n={rootMargin:n,threshold:.5,root:r},(r=new IntersectionObserver(S,n)).observe(i.node),i.observers.step=r,m&&O({id:a,step:i,marginTop:s,marginBottom:o}),t&&(n=e,r=window.innerHeight,i=n.offset||f,s="pixels"===i.format?1:r,r=(s=-(i=i.value*s)+n.height)+`px 0px ${i-=r}px 0px`,s=((e,t)=>{var o=Math.ceil(e/t),n=[],r=1/o;for(let e=0;e<o+1;e+=1)n.push(e*r);return n})(n.height,h),i={rootMargin:r,threshold:s},(r=new IntersectionObserver(M,i)).observe(n.node),n.observers.progress=r)}function A(){q(),t=new ResizeObserver(e),p.forEach(e=>t.observe(e.node)),p.forEach(e=>Y(e,g))}let N={};return N.setup=({step:e,parent:t,offset:o=.5,threshold:n=4,progress:r=!1,once:i=!1,debug:s=!1,container:a=void 0,root:l=null})=>{B(a);[e,t=document]=[e,t];t="string"==typeof e?Array.from(t.querySelectorAll(e)):e instanceof Element?[e]:e instanceof NodeList?Array.from(e):e instanceof Array?e:[];let c=t.map(e=>({height:e.offsetHeight,top:e.getBoundingClientRect().top+window.pageYOffset-(document.body.clientTop||0)}));return(p=t.map((e,t)=>({index:t,direction:void 0,height:c[t].height,node:e,observers:{},offset:I(e.dataset.offset),top:c[t].top,progress:0,state:void 0}))).length?(g=r,v=i,m&&!s&&T(),m=s,h=Math.max(1,+n),f=I(o),d=a,u=l,x(),P(p),y(!0)):z("no step elements"),N},N.enable=()=>(y(!0),N),N.disable=()=>(y(!1),N),N.destroy=()=>{var e,t;return y(!1),x(),e=(e=d)||window,j.has(e)&&(--(t=j.get(e)).count,0===t.count)&&(e.removeEventListener("scroll",t.listener),j.delete(e)),m&&T(),p=[],N},N.resize=()=>(A(),N),N.offset=e=>null==e?f.value:(f=I(e),A(),N),N.onStepEnter=e=>("function"==typeof e?i.stepEnter=e:z("onStepEnter requires a function"),N),N.onStepExit=e=>("function"==typeof e?i.stepExit=e:z("onStepExit requires a function"),N),N.onStepProgress=e=>("function"==typeof e?i.stepProgress=e:z("onStepProgress requires a function"),N),N}});
